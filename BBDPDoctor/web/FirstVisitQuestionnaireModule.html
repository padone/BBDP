<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"> 
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>BBDP</title>
		<link rel="Shortcut Icon" type="image/x-icon" href="img/frame/icon.ico">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<link href="frame/metisMenu/metisMenu.css" rel="stylesheet">
		<script src="frame/metisMenu/metisMenu.js"></script>
		<link href="frame/sb-admin-2/sb-admin-2.css" rel="stylesheet">
		<script src="frame/sb-admin-2/sb-admin-2.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<!-- 醫生端框架 css -->
		<link href="css/doctorFrame.css" rel="stylesheet">
		<script src="js/questionnaire.js"></script>
	</head>
	<body>
		<div id="wrapper">
			<!-- prepend navbar in doctorFrame.js -->
			<div id="page-wrapper">
				<div class="row">
					<!-- 內容 -->
					<div class="col-md-12">
						<div class="row">
							<!-- 左邊灰框 -->
							<div class="col-md-4" style="margin-top: 3vh; margin-bottom: 3vh;">
								<div class="row">
									<div class="col-md-12 col-sm-12 col-xs-12">
										<button type="button" class="btn btn-default" onclick="location.href='NewQuestionnaireModule.html'">新增問卷模板</button>
									</div>
								</div>
								<div class="row">
									<div class="col-md-12">
										<br />
									</div>
								</div>
								<div class="row">
									<div class="col-md-12">
										<div class="panel panel-default left-list" style="min-height: 73vh; max-height: 73vh;">
											<div class="panel-heading">							
												<button type="button" class="btn btn-default" onclick="location.href='FirstVisitQuestionnaireModule.html'">初診問卷模板</button>
											</div>
											<div class="panel-heading">
												<form>
													<!-- 左邊灰框上面的選單 -->
													<select class="form-control" id="questionnaireType" onclick="changeQuestionnaireType()">
														<option value="">問卷模板分類</option>
													</select>
												</form>
											</div>
											<div class="panel-body" style="overflow-y: auto;">
												<div class="list-group" id = "questionnaireList">
													<!-- 左邊灰框下面的項目(動態產生) -->

												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-8" style="margin-top: 3vh; margin-bottom: 3vh;">
								<div class="row">
									<div class="col-md-10 col-sm-10 col-xs-9">
										<input type="text" class="form-control invisible" />
									</div>
									<div class="col-md-2 col-sm-2 col-xs-3"></div>
								</div>
								<div class="row">
									<div class="col-md-12">
										<br />
									</div>
								</div>
								<div class="row">
									<div class="col-md-12">
										<!-- 右邊灰框 -->
										<div class="panel panel-default right-content" style="min-height: 73vh; max-height: 73vh;">
											<div class="panel-heading">
												<div class="row" style="margin-left: 0.5vw;">
													<h4>新增初診問卷模板</h4>
												</div>
												<div class="row" style="margin-left: 0.5vw;">
													<h5><b>問卷模板</b></h5>
												</div>
												<!-- 右邊灰框上面的分類 -->
												<div class="row">
													<div class="col-md-4" style="margin-bottom: 0.5vh; margin-top: 0.5vh;">
														<select class="form-control" id="selectType" onChange="changeType()">
															<option value="all">問卷模板分類</option>
														</select>
													</div>
													<div class="col-md-4" style="margin-bottom: 0.5vh; margin-top: 0.5vh;">
														<select class="form-control" id="selectQuestionnaire">
															<option value="">請選擇問卷</option>
														</select>
													</div>
												</div>
												<div class="row" style="margin-left: 0.5vw;">
													<h5><b>顯示症狀</b></h5>
												</div>
												<!-- 右邊灰框上面的症狀 -->
												<div class="row">
													<div class="col-md-4">
														<select class="form-control" id="selectSymptom" onChange="changeSymptom()">
															<option value="other">請選擇症狀</option>
														</select>
													</div>
													<div class="col-md-1">
														<h5>或</h5>
													</div>
													<div class="col-md-4">
														<input type="text" class="form-control" id="inputSymptom" placeholder="請輸入要新增的症狀名稱..." />
													</div>
												</div>
												<div class="row" style="margin-top: 2vh;">
													<div class="col-md-12">
														<!-- 右邊灰框上面的新增按鈕 -->
														<button type="button" class="btn btn-default" onclick="addFirstVisitQuestionnaire()">新增</button>
													</div>
												</div>
											</div>
											<div class="panel-body" style="overflow-y: auto;">
												<!-- 右邊灰框下面的表格 -->
												<table class="table table-bordered table-hover">
													<thead>
														<tr>
															<th style="background-color: #2e2d4d; color: white;">症狀</th>
															<th style="background-color: #2e2d4d; color: white;">問卷模板</th>
															<th style="background-color: #2e2d4d; color: white;">刪除</th>
														</tr>
													</thead>
													<tbody id = "firstVisitQuestionnaireList">
														<!-- 右邊灰框下面表格的初診問卷模板列表(動態產生) -->
													</tbody>
												</table>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 症狀重複取代訊息 modal -->
		<div id="sendAgainModal" class="modal fade" role="dialog">
			<div class="modal-dialog modal-sm">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 id="alertTitle" class="modal-title">症狀重複</h4>		<!-- 提示訊息 modal 標題 -->
					</div>
					<div class="modal-body">
						<p>取代此症狀的初診問卷？</p>		<!-- 提示訊息 modal 內容 -->
					</div>
					<div class="modal-footer">				<!-- 按鈕可以只有確定，onclick的function可自行更改 -->
						<button type="button" class="btn btn-default" data-dismiss="modal" onclick="sendAgain()">確定</button>
						<button type="button" class="btn btn-default" onclick="window.location.reload()">取消</button>
					</div>
				</div>
			</div>
		</div>		
		<!-- 醫生端框架 js -->
		<script src="js/doctorFrame.js"></script>
		<script src="js/modalGenerator.js"></script>
		<!-- 計算高度 -->
		<script>
			var nowSymptom = 1;	//0選擇 1輸入
			$(document).ready(function(){
				$.ajax({
					url : "QuestionnaireModuleServlet",
					data : {
						state : "getFirstVisitQuestionnaire",					
					},
					dataType : "json",
			
					success : function(response) {
						$("#firstVisitQuestionnaireList").empty();
						$("#selectSymptom").empty();
						var tempSymptom = "<option value='other'>請選擇症狀</option>";	
						var temp = "";
						for(var i=0; i<response.length; i+=3){
							temp += "<tr>";
							temp += "<td style='width:25%'>"+response[i+2]+"</td>";
							temp += "<td style='width:60%'>"+response[i+1]+"</td>";
							temp += "<td><button type='button' class='btn btn-default btn-sm' onclick='removeFirstVisitQuestionnaire(\""+response[i]+"\")'>刪除</button></td>";								
							temp += "</tr>";
							
							tempSymptom += "<option value='"+response[i+2]+"'>"+response[i+2]+"</option>";
						}
						$("#selectSymptom").append(tempSymptom);
						$("#firstVisitQuestionnaireList").append(temp);
					},
					error : function() {
						console.log("錯誤訊息");
					}
				});
				$.ajax({
					url : "QuestionnaireModuleServlet",
					data : {
						state : "searchType",					
					},
					dataType : "json",
			
					success : function(response) {
						$("#selectType").empty();
						var temp = "<option value='all'>問卷模板分類</option>";
						for(var i=0; i<response.length; i++){
							temp+="<option value='"+response[i]+"'>"+response[i]+"</option>";
						}
						$("#selectType").append(temp);
					},
					error : function() {
						console.log("錯誤訊息");
					}
				});
				$.ajax({
					url : "QuestionnaireModuleServlet",
					data : {
						state : "searchAllQuestionnaire",
					},
					dataType : "json",

					success : function(response) {
						$("#selectQuestionnaire").empty();
						var temp = "<option value=''>請選擇問卷</option>";	
						for(var i=0; i<response.length; i+=3){
							temp += "<option value='"+response[i]+"'>"+response[i+1]+"</option>";
						}
						$("#selectQuestionnaire").append(temp);					
					},
					error : function() {
						console.log("錯誤訊息");
					}
				});
			});
			function changeType(){
				var state = "searchQuestionnaire";
				if($('#selectType option:selected').val()=="all") state = "searchAllQuestionnaire"

				$.ajax({
					url : "QuestionnaireModuleServlet",
					data : {
						state : state,
						type : htmlEscapeCharacter($('#selectType option:selected').val())
					},
					dataType : "json",

					success : function(response) {
						$("#selectQuestionnaire").empty();
						var temp = "<option value=''>請選擇問卷</option>";	
						for(var i=0; i<response.length; i+=3){
							temp += "<option value='"+response[i]+"'>"+response[i+1]+"</option>";
						}
						$("#selectQuestionnaire").append(temp);		
					},
					error : function() {
						console.log("錯誤訊息");
					}
				});	
			}
			function addFirstVisitQuestionnaire(){
				var tempSymptom = "";
				if($('#selectQuestionnaire option:selected').val()){
					if((nowSymptom == 1 && $('#inputSymptom').val())||nowSymptom == 0){
						if(nowSymptom) tempSymptom = $('#inputSymptom').val();
						else tempSymptom = $('#selectSymptom option:selected').val();
						$.ajax({
							url : "QuestionnaireModuleServlet",
							data : {
								state : "addFirstVisitQuestionnaire",
								questionnaireID : $('#selectQuestionnaire option:selected').val(),
								questionnaireSymptom : htmlEscapeCharacter(tempSymptom)				
							},
							dataType : "json",					
							success : function(response) {
								if (response==1) {
									window.location.reload();
								}else if (response==2){
									$("#sendAgainModal").modal("show");
								}								
							},
							error : function() {
							alert("xdfgszd");
								console.log("錯誤訊息");
							}
						});
					}else modalGenerator("提示", "請選擇或新增症狀");
				}else modalGenerator("提示", "請選擇問卷");	
			}
			function sendAgain(){
				if(nowSymptom) tempSymptom = $('#inputSymptom').val();
				else tempSymptom = $('#selectSymptom option:selected').val();
				$.ajax({
					url : "QuestionnaireModuleServlet",
					data : {
						state : "updateFirstVisitQuestionnaire",
						questionnaireID : $('#selectQuestionnaire option:selected').val(),
						questionnaireSymptom : htmlEscapeCharacter(tempSymptom)				
					},
					dataType : "json",					
					success : function(response) {
						window.location.reload();					
					},
					error : function() {
						console.log("錯誤訊息");
					}
				});	
			}
			function removeFirstVisitQuestionnaire(num){
				$.ajax({
					url : "QuestionnaireModuleServlet",
					data : {
						state : "removeFirstVisitQuestionnaire",
						questionnaireID : num							
					},			
					success : function(response) {
						window.location.reload();
					},
					error : function() {
						console.log("錯誤訊息");
					}
				});	
			}
			//左邊灰框的panel-body高度
			$(".left-list > .panel-body").css("min-height", "55vh");
			$(".left-list > .panel-body").css("max-height", "55vh");
			//右邊灰框的panel-body高度
			$(".right-content > .panel-body").css("height", $(".right-content").outerHeight() - $(".right-content > .panel-heading").outerHeight() - 8);
		</script>
	</body>
</html>